## 请求日志

对于 helm chart 部署，可以指定如下：

```yaml
servers:
  - zones:
      - zone: .
    port: 53
    plugins:
      - name: errors
      - name: log
      // ...
```

即生成配置：

```yaml
Corefile: |
    .:53 {
        errors
        log // 此处添加Log插件。
        health {
           lameduck 5s
        }
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa {
          pods insecure
          upstream
          fallthrough in-addr.arpa ip6.arpa
          ttl 30
        }
        prometheus :9153
        forward . /etc/resolv.conf
        cache 30
        loop
        reload
        loadbalance
    }
  }
```

CoreDNS 接收到请求并回复客户端后会打印一行日志，示例如下：

```plain
# 其中包含状态码 RCODE NOERROR，代表解析结果正常返回

[INFO] 172.20.2.25:44525 - 36259 "A IN redis-master.default.svc.cluster.local. udp 56 false 512" NOERROR qr,aa,rd 110 0.000116946s
```

## 监控数据

官方文档：<https://coredns.io/plugins/metrics/>

重点指标如下：

| 指标类型                               | 指标说明                   | 告警设置                                                     |
| -------------------------------------- | -------------------------- | ------------------------------------------------------------ |
| `coredns_dns_requests_total`           | 请求次数                   | 可针对总量进行告警，判断当前域名解析 QPS 是否过高            |
| `coredns_dns_responses_total`          | 响应次数                   | 可针对不同状态码 RCODE 的响应次数进行告警，例如服务端异常 SERVFAIL 出现时，可进行告警 |
| `coredns_panics_total`                 | CoreDNS 程序异常退出的次数 | 大于 0 则说明异常发生，应进行告警                            |
| `coredns_dns_request_duration_seconds` | 域名解析延迟               | 延迟过高时应进行告警                                         |


