## 考试大纲

**集群安装：10%**

- 使用网络安全策略来限制集群级别的访问
- 使用 CIS 基准检查 Kubernetes 组件（etcd, kubelet, kubedns, kubeapi）的安全配置
- 正确设置带有安全控制的 Ingress 对象
- 保护节点元数据和端点
- 最小化 GUI 元素的使用和访问
- 在部署之前验证平台二进制文件

## 默认网络策略

题目描述：

- 为所有类型为 Ingress+Egress 的流量在 namespace `testing` 中创建一个名为 `denypolicy` 的新默认拒绝 NetworkPolicy
- 此新的 NetworkPolicy 必须拒绝 namespace `testing` 中的所有的 Ingress + Egress 流量
- 将新创建的默认拒绝 NetworkPolicy 应用与在 namespace `testing` 中运行的所有 Pod

官方文档：

- <https://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/>

参考解答：

```yaml
# vim defaultdeny.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: denypolicy
  namespace: testing
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
```

## kube-bench 修复不安全项

题目描述：

- 针对 kubeadm 创建的 cluster 运行 CIS 基准测试工具时，发现了多个必须立即解决的问题

- 通过配置修复所有问题并重新启动受影响的组件以确保新的设置生效

  ```bash
  修复针对 API 服务器发现的所有以下违规行为：
  1.2.7 Ensure that the --authorization-mode argument is not set to AlwaysAllow FAIL 
  1.2.8 Ensure that the --authorization-mode argument includes Node FAIL 
  1.2.9 Ensure that the --authorization-mode argument includes RBAC FAIL 
  1.2.18 Ensure that the --insecure-bind-address argument is not set FAIL 
  
  修复针对 kubelet 发现的所有以下违规行为：
  Fix all of the following violations that were found against the kubelet:
  4.2.1 Ensure that the anonymous-auth argument is set to false FAIL
  4.2.2 Ensure that the --authorization-mode argument is not set to AlwaysAllow FAIL
  注意：尽可能使用 Webhook 身份验证/授权。
  
  修复针对 etcd 发现的所有以下违规行为：
  Fix all of the following violations that were found against etcd:
  2.2 Ensure that the --client-cert-auth argument is set to true FAIL
  ```

官方文档：

- 

参考解答：

切换到 Master 的 root 下

```css
ssh master01
sudo -i
```

开始操作前先备份

````bash
cp /etc/kubernetes/manifests/kube-apiserver.yaml /tmp
cp /etc/kubernetes/manifests/etcd.yaml /tmp
cp /var/lib/kubelet/config.yaml /tmp
````

修改 api-server

可以使用这条命令查。考试时，可以不查的，直接按照考试题目里的要求做就行。可能很多不安全项，但只修改考题要求的哪几项就行的。

```bash
kube-bench master
```

注意：在修改之前最好备份一下，可以备份到 /tmp 目录下，不要备份到当前目录

```bash
# 修改config文件
vim /etc/kubernetes/manifests/kube-apiserver.yaml

# 修改authorization-mode为Node,RBAC
- --authorization-mode=Node,RBAC

# 删除 insecure-bind-address
- --insecure-bind-address=0.0.0.0
```

检查 kubelet，注意：master 和 node 里面都要看一下

```bash
kube-bench node
```

修改：

```yaml
# 修改config文件
vim /var/lib/kubelet/config.yaml

# 修改内容
apiVersion: kubelet.config.k8s.io/v1beta1
authentication:
  anonymous: 
    enabled: false #将 true 改为 false
  webhook:
    cacheTTL: 0s
    enabled: true # 修改为 true。注意，这两个 enabled 千万不要搞混，anonymous 应该为 false，webhook 应该为 true。考试时，可能只有一个是错误的。
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.crt
authorization:
  mode: Webhook #改为 Webhook
  webhook:
```

检查 etcd

```bash
kube-bench run --targets etcd
```

修改 etcd：

```bash
# 修改 etcd.yaml
- --client-cert-auth=true #修改为 true

# 修改完成后，重新加载配置文件，并重启kubelet
systemctl daemon-reload
systemctl restart kubelet
```

注意：做下一题之前，确保所有的 pod 都是 Running，特别是 kube-apiserver-master01 也正常。（考试时，也要确保这个 apiserver 是正常的）可以通过 `kubectl get pod -A`进行查看