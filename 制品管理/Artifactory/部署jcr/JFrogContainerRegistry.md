## 安装

使用 Docker 安装的官方文档地址：<https://www.jfrog.com/confluence/display/JFROG/Installing+Artifactory#InstallingArtifactory-DockerInstallation>

### 镜像拉取

版本发布页面：<https://www.jfrog.com/confluence/display/JFROG/Artifactory+Release+Notes>

目前最新版本是 7.46.11，详见：<https://www.jfrog.com/confluence/display/JFROG/Artifactory+Release+Notes#ArtifactoryReleaseNotes-Artifactory7.46>

```bash
docker pull releases-docker.jfrog.io/jfrog/artifactory-jcr:7.46.11
```

### 持久化目录

先准备一个持久化目录

```bash
export JFROG_HOME=/registry
```

新建一个配置文件

```bash
mkdir -p $JFROG_HOME/artifactory/var/etc/

touch $JFROG_HOME/artifactory/var/etc/system.yaml
```

更改目录权限

```bash
chown -R 1030:1030 $JFROG_HOME/artifactory/var
```

### 启动容器

按照如下方式启动容器

```bash
docker run \
  --name artifactory \
  -itd \
  --restart=always \
  -v $JFROG_HOME/artifactory/var/:/var/opt/jfrog/artifactory \
  -p 8081:8081 \
  -p 8082:8082 \
  releases-docker.jfrog.io/jfrog/artifactory-jcr:7.46.11
```

### 配置

打开本地浏览器，访问 `serverIP:8081`；用户名：admin / 密码：password

先根据提示进行初始化，然后进入左侧的系统设置 ”JFrog Container Registry“

选择 http settings，进行如下配置：

- Docker 仓库使用 "Repository Path" 方式
- 反向代理选择 Nginx
  - 配置使用 https
  - 端口可任意设置（例如 5000）
  - ssl 路径填写 `/cert/tls.key` 和 `/cert/tls.crt`（与反向代理的挂载和配置有关，可自由设置）

配置完成后点击保存，例如这里生成的配置（可在界面的 View 选项中查看）：

```nginx
###########################################################
## this configuration was generated by JFrog Artifactory ##
###########################################################

## add ssl entries when https has been set in config
ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
ssl_certificate      /cert/tls.crt;
ssl_certificate_key  /cert/tls.key;
ssl_session_cache shared:SSL:1m;
ssl_prefer_server_ciphers   on;
## server configuration
server {
    listen 5000 ssl;
    
    
    server_name jcr.local.liaosirui.com;
    if ($http_x_forwarded_proto = '') {
        set $http_x_forwarded_proto  $scheme;
    }
    ## Application specific logs
    ## access_log /var/log/nginx/jcr.local.liaosirui.com-access.log timing;
    ## error_log /var/log/nginx/jcr.local.liaosirui.com-error.log;
    rewrite ^/$ /ui/ redirect;
    rewrite ^/ui$ /ui/ redirect;
    chunked_transfer_encoding on;
    client_max_body_size 0;
    location / {
    proxy_read_timeout  2400s;
    proxy_pass_header   Server;
    proxy_cookie_path   ~*^/.* /;
    proxy_buffer_size 128k;
    proxy_buffers 40 128k;
    proxy_busy_buffers_size 128k;
    proxy_pass          http://10.244.244.103:8082;
    proxy_set_header    X-JFrog-Override-Base-Url $http_x_forwarded_proto://$host:$server_port;
    proxy_set_header    X-Forwarded-Port  $server_port;
    proxy_set_header    X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_set_header    Host              $http_host;
    proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Strict-Transport-Security always;

        location ~ ^/artifactory/ {
            proxy_pass    http://10.244.244.103:8081;
        }
    }
}

```

### 配置反向代理

创建证书文件夹

```bash
mkdir -p $JFROG_HOME/artifactory-proxy/cert
```

依次创建证书所需文件

```bash
cat << _EOF_ > $JFROG_HOME/artifactory-proxy/cert/tls.key
-----BEGIN RSA PRIVATE KEY-----
MIIEpQIBAAKCAQEA1LlAM4Ia6X1U6RrJReVZeDnCpXcRugKnd99o+0SsR2PuB7xD
x9VFSFvD20VvVFwp0+RoCQNUNG62uI4W2WVyH6BHLzTVhta+jwp6dQHgIG+Sk6Am
59DgCaWq/4HTJ0oXyGKcoxrkzMLEf6Xt3EJBN+RSFG3PA5UUQCBIgllaTt8vEDRd
gz2v0rTUcO7C5RV30Pnjj4QdYvJtP1RxYDwis0pAeBm3aML60t9txM4jv73FglLU
sEd+WHcP9bQUXn4i7vvTNk5nz7PUzD8IPBomlo14enViu7W+2qCyCy6F+ByAHZqc
ljKlHoiG7rgEcLtlpDxzZRbK0DpyxMiMy3ZuIwIDAQABAoIBAB+POFor9Egtwvou
civ/gc2XbCxWRPf+ys+7An08y/5vcfIN2VR9bKD2lFEktQakAcSg/1pO9yAsSMmK
sxMfvNW6VrVHNmKh23WnTVGsrI7DXtCuEveTgpmLzZnIrgYHNQ4Sq0B7jfRe9P4n
JOnnnntnUVIclHjoli+JWpiUHxTSPHlC8COkKq6hzxG0jFBez8f3akmO3MBTe0q2
tAEFL7TWZGKVcA3+md58Xc5trC4XJVlIwddEU/7p5CgVw7pZ61kWZniEsziwMDiq
d9iU5YIXyw3AG5s/xELmGtSYjfWQeXcyLVeFbOso5oROTKasSVL5OlHfkBdAHJrH
QTCHWNECgYEA9Xgi4SwXsxM9YC/9xJzFLou3QKAGhseyuSgvkH5Fsc2LJ8sKwlzz
uyofxHs5H0HVvPyXHUTknwcQUDLzetDyTrRrVmdWuplW1DhpZd3Lj60Pvnq3B5FY
TFLUQco8AsXdoHcA5Sv1OqGCG7Sh7x+xweAeaNnuhEtFbbheadrISZkCgYEA3dl8
X0ivfzBNGR1GdTAWW5NE12kaDim17qRE9HqddIECBQjz0jo1/UEcOjxaJ85BQHX8
TIxR208+zj4UuhfI0M5HTbvZD/1gN4EYoP95vatLF2av3ZdwBb8bWsbf21FACAW2
HJSH6pdpbPWOTdipYTmcTxN+X5A/PvMW6Qw04xsCgYEAlBBKIb6B8R961wk7rhvO
CJx4BgBAz42nbW4i+qpgCbbs6CzeKYz963imPtMBCqyga2WFFT+YE6CkI2wIV52v
eu/zCuQ8eUPDDzGTycE2Z0zBgWjt/B+cvjT8GU8OUbHeVEtT++g+/IWtQF79iop4
o3Q3g5FpAN2SXHNoZ7tzMokCgYEAgoeURfveRleFBWHUMt84SGk9+AA+9FZWVTMR
30bFnebJ6Wx7CRZ27auBkEIySXlxqxvAdsmY4BCgQ3kDePrFjRXRnksITAAovH+Y
niGy34YJiJtCnn6bysXGsoKQ89m6cv3pSKeb0MuFnDZepC72ed4LufseP9v/Wmps
8HHeLEECgYEAqHF9k+vtHpMwUqcZnDmlkhcN1+4HagdF53crxXDNzu/bdAhYrCSZ
U1jqz18Be3DJTHvutI12Xs2q7ubhlChbt8y3Eo3CbJzPcxpBhzm3r25G2E8WtpxD
0qBLjJtJpZifY7yYESVpad36zOTpMoQt/cAuScqGMZGZqblILrBteyY=
-----END RSA PRIVATE KEY-----
_EOF_

cat << _EOF_ > $JFROG_HOME/artifactory-proxy/cert/tls.crt
-----BEGIN CERTIFICATE-----
MIIGAzCCBOugAwIBAgIQBegMrPHxIyhYyvWpdQypwDANBgkqhkiG9w0BAQsFADBu
MQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMRkwFwYDVQQLExB3
d3cuZGlnaWNlcnQuY29tMS0wKwYDVQQDEyRFbmNyeXB0aW9uIEV2ZXJ5d2hlcmUg
RFYgVExTIENBIC0gRzEwHhcNMjIxMTEzMDAwMDAwWhcNMjMxMTEzMjM1OTU5WjAi
MSAwHgYDVQQDExdqY3IubG9jYWwubGlhb3NpcnVpLmNvbTCCASIwDQYJKoZIhvcN
AQEBBQADggEPADCCAQoCggEBANS5QDOCGul9VOkayUXlWXg5wqV3EboCp3ffaPtE
rEdj7ge8Q8fVRUhbw9tFb1RcKdPkaAkDVDRutriOFtllch+gRy801YbWvo8KenUB
4CBvkpOgJufQ4Amlqv+B0ydKF8hinKMa5MzCxH+l7dxCQTfkUhRtzwOVFEAgSIJZ
Wk7fLxA0XYM9r9K01HDuwuUVd9D544+EHWLybT9UcWA8IrNKQHgZt2jC+tLfbcTO
I7+9xYJS1LBHflh3D/W0FF5+Iu770zZOZ8+z1Mw/CDwaJpaNeHp1Yru1vtqgsgsu
hfgcgB2anJYypR6Ihu64BHC7ZaQ8c2UWytA6csTIjMt2biMCAwEAAaOCAucwggLj
MB8GA1UdIwQYMBaAFFV0T7JyT/VgulDR1+ZRXJoBhxrXMB0GA1UdDgQWBBQhGcBM
n2VumUYbu61k60ZIoDUMbTAiBgNVHREEGzAZghdqY3IubG9jYWwubGlhb3NpcnVp
LmNvbTAOBgNVHQ8BAf8EBAMCBaAwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUF
BwMCMD4GA1UdIAQ3MDUwMwYGZ4EMAQIBMCkwJwYIKwYBBQUHAgEWG2h0dHA6Ly93
d3cuZGlnaWNlcnQuY29tL0NQUzCBgAYIKwYBBQUHAQEEdDByMCQGCCsGAQUFBzAB
hhhodHRwOi8vb2NzcC5kaWdpY2VydC5jb20wSgYIKwYBBQUHMAKGPmh0dHA6Ly9j
YWNlcnRzLmRpZ2ljZXJ0LmNvbS9FbmNyeXB0aW9uRXZlcnl3aGVyZURWVExTQ0Et
RzEuY3J0MAkGA1UdEwQCMAAwggF+BgorBgEEAdZ5AgQCBIIBbgSCAWoBaAB2AOg+
0No+9QY1MudXKLyJa8kD08vREWvs62nhd31tBr1uAAABhHG63eoAAAQDAEcwRQIg
DvrYJ7fUWCStt+DnP+YpFcUqC6shBps3lezm9mAZ6XkCIQCZuuJeVAJ8SDxvjjUX
Fi5GGXviXhLrwYqoO7Yzo7w+YQB1ALNzdwfhhFD4Y4bWBancEQlKeS2xZwwLh9zw
Aw55NqWaAAABhHG63goAAAQDAEYwRAIgPesISrOW8HJKC2SQX4AlSx3jn3oP5x0y
VE1oBzVaHsYCIFOXrbg46YmnrFaMhARHwo+EcBQ29LRPE+QR9RW4wQU1AHcAtz77
JN+cTbp18jnFulj0bF38Qs96nzXEnh0JgSXttJkAAAGEcbrdwwAABAMASDBGAiEA
+4SuMD3XeP4OWdEV9ZUQIAAy+BU5hALSpGGiZ9pRSuMCIQDxJ+3AcJ2wAkaAF2A4
F273Xk8j3MoTafJZsASOeQ6IGzANBgkqhkiG9w0BAQsFAAOCAQEAV5v2tTpUbk3O
peTS3Ao7bzM3hqvoQZQ+E14662XVA3jMkvf3j3OnZavFKr5kY2AvGsU55fe+vfoK
tM80+bVeYtQ8EkZG4Fe6NFu+c+E8FzpOmXb1GtcCyxk4k3TnN52kO9CmCk6sWL1j
VJ+tyqAtrmhUFKqOglBaOC8J/3HNV0/ERaGN9AlQB16qZ3r9u7Fb2+HjN257rtYn
scrDjukXI2tZZM3QFnGW/KzvHZlrcnMy8C/VBDixXQP1k2JdnO0p6f6FQ9HLMXIp
2+djW6S4juqXU32efV5lGzq5BtRDcrmaGm5Ly/yTCu8HiBdxKGU4jVw6zqNMTdV3
mTYcRWWIIQ==
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIEqjCCA5KgAwIBAgIQAnmsRYvBskWr+YBTzSybsTANBgkqhkiG9w0BAQsFADBh
MQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMRkwFwYDVQQLExB3
d3cuZGlnaWNlcnQuY29tMSAwHgYDVQQDExdEaWdpQ2VydCBHbG9iYWwgUm9vdCBD
QTAeFw0xNzExMjcxMjQ2MTBaFw0yNzExMjcxMjQ2MTBaMG4xCzAJBgNVBAYTAlVT
MRUwEwYDVQQKEwxEaWdpQ2VydCBJbmMxGTAXBgNVBAsTEHd3dy5kaWdpY2VydC5j
b20xLTArBgNVBAMTJEVuY3J5cHRpb24gRXZlcnl3aGVyZSBEViBUTFMgQ0EgLSBH
MTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALPeP6wkab41dyQh6mKc
oHqt3jRIxW5MDvf9QyiOR7VfFwK656es0UFiIb74N9pRntzF1UgYzDGu3ppZVMdo
lbxhm6dWS9OK/lFehKNT0OYI9aqk6F+U7cA6jxSC+iDBPXwdF4rs3KRyp3aQn6pj
pp1yr7IB6Y4zv72Ee/PlZ/6rK6InC6WpK0nPVOYR7n9iDuPe1E4IxUMBH/T33+3h
yuH3dvfgiWUOUkjdpMbyxX+XNle5uEIiyBsi4IvbcTCh8ruifCIi5mDXkZrnMT8n
wfYCV6v6kDdXkbgGRLKsR4pucbJtbKqIkUGxuZI2t7pfewKRc5nWecvDBZf3+p1M
pA8CAwEAAaOCAU8wggFLMB0GA1UdDgQWBBRVdE+yck/1YLpQ0dfmUVyaAYca1zAf
BgNVHSMEGDAWgBQD3lA1VtFMu2bwo+IbG8OXsj3RVTAOBgNVHQ8BAf8EBAMCAYYw
HQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUFBwMCMBIGA1UdEwEB/wQIMAYBAf8C
AQAwNAYIKwYBBQUHAQEEKDAmMCQGCCsGAQUFBzABhhhodHRwOi8vb2NzcC5kaWdp
Y2VydC5jb20wQgYDVR0fBDswOTA3oDWgM4YxaHR0cDovL2NybDMuZGlnaWNlcnQu
Y29tL0RpZ2lDZXJ0R2xvYmFsUm9vdENBLmNybDBMBgNVHSAERTBDMDcGCWCGSAGG
/WwBAjAqMCgGCCsGAQUFBwIBFhxodHRwczovL3d3dy5kaWdpY2VydC5jb20vQ1BT
MAgGBmeBDAECATANBgkqhkiG9w0BAQsFAAOCAQEAK3Gp6/aGq7aBZsxf/oQ+TD/B
SwW3AU4ETK+GQf2kFzYZkby5SFrHdPomunx2HBzViUchGoofGgg7gHW0W3MlQAXW
M0r5LUvStcr82QDWYNPaUy4taCQmyaJ+VB+6wxHstSigOlSNF2a6vg4rgexixeiV
4YSB03Yqp2t3TeZHM9ESfkus74nQyW7pRGezj+TC44xCagCQQOzzNmzEAP2SnCrJ
sNE2DpRVMnL8J6xBRdjmOsC3N6cQuKuRXbzByVBjCqAA8t1L0I+9wXJerLPyErjy
rMKWaBFLmfK/AHNF4ZihwPGOc7w6UHczBZXH5RFzJNnww+WnKuTPI0HfnVH8lg==
-----END CERTIFICATE-----
_EOF_
```

创建 nginx 配置文件夹：

```bash
mkdir -p $JFROG_HOME/artifactory-proxy/conf
```

创建 nginx 主配置文件 `$JFROG_HOME/artifactory-proxy/conf/nginx.conf`，内容如下：

```nginx
user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    include /etc/nginx/conf.d/artifactory.conf;
}
```

按照 artifactory 生成的配置文件配置 `$JFROG_HOME/artifactory-proxy/conf/artifactory.conf`

拉取所需镜像

```bash
docker pull docker.io/library/nginx:1.23.2-alpine
```

新建 nginx 的配置文件

```bash
docker run \
 --name artifactory-proxy \
 -itd \
  --restart=always \
  -v $JFROG_HOME/artifactory-proxy/cert:/cert \
  -v $JFROG_HOME/artifactory-proxy/conf/nginx.conf:/etc/nginx/nginx.conf \
  -v $JFROG_HOME/artifactory-proxy/conf/artifactory.conf:/etc/nginx/conf.d/artifactory.conf \
  docker.io/library/nginx:1.23.2-alpine
```

