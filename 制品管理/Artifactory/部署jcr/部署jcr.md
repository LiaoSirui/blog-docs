
## 仓库访问方式

当选择镜像仓库后，按照基础配置只需要填写一个 RepositoryKey 就可以了，key 很重要，作为仓库的唯一标识

在jfrog系统http配置中，对于docker access提供了三种不同的访问方式，默认为Repository path，这三种方式影响的是push/pull镜像时所使用的格式。

### Port

使用port方式访问时，在新建docker仓库时需要指定docker registry的binding port，对于每个镜像仓库都会使用一个不同的端口来区分不同的repository

镜像格式：

```bash
docker pull / push 192.168.26.2:<REPOSITORY_PORT>/<IMAGE>:<TAG>
docker login -u <USER_NAME> -p <USER_PASSWORD> 192.168.26.2:<REPOSITORY_PORT>
```

### Repository Path(default)

使用path方式时，不需要占用和配置额外的registry端口，而是通过url的path来区分

镜像格式：

```bash
docker pull / push 192.168.26.2:8081/<REPOSITORY_KEY>/<IMAGE>:<TAG>
docker login -u <USER_NAME> -p <USER_PASSWORD> 192.168.26.2:8081
```

### Sub domain

使用sub domain时，需要配置 server name expression

镜像格式：

```bash
docker pull / push <REPOSITORY_KEY>.192.168.26.2/<IMAGE>:<TAG>
docker login -u <USER_NAME> -p <USER_PASSWORD> <REPOSITORY_KEY>.192.168.26.2
```

## 启动容器

文档使用的镜像清单

```bash
docker.io/openresty/openresty:1.21.4.1-2-alpine
releases-docker.jfrog.io/jfrog/artifactory-jcr:7.41.7
# releases-docker.jfrog.io/jfrog/artifactory-jcr:latest
```

准备数据目录

```bash
# 定义基础数据目录
export JFROG_HOME=/data/artifactory-data

mkdir -p $JFROG_HOME/artifactory/var/etc/ && cd $JFROG_HOME/artifactory/var/etc/
touch ./system.yaml
chown -R 1030:1030 $JFROG_HOME/artifactory/var
```

启动 artifactory-jcr

```bash

docker run \
    --name artifactory \
    -itd \
    -v $JFROG_HOME/artifactory/var/:/var/opt/jfrog/artifactory \
    -p 8081:8081 \
    -p 8082:8082 \
    releases-docker.jfrog.io/jfrog/artifactory-jcr:7.41.7
```

访问浏览器，输入地址，例如 192.168.31.100:8081

初始用户名密码：admin /  password 登录后修改即可

登录后进行初始化流程：<http://192.168.31.100:8082/ui/admin/onboarding-page>

## 配置 nginx 代理

先配置好镜像仓库使用的类型，比如这里选择的 port 方式

artifactory 会自动生成配置文件

```nginx
###########################################################
## this configuration was generated by JFrog Artifactory ##
###########################################################

## server configuration
server {
     
    listen 18082 ;
     
    server_name 192.168.31.100;
    if ($http_x_forwarded_proto = '') {
        set $http_x_forwarded_proto  $scheme;
    }
    ## Application specific logs
    ## access_log /var/log/nginx/192.168.31.100-access.log timing;
    ## error_log /var/log/nginx/192.168.31.100-error.log;
    rewrite ^/$ /ui/ redirect;
    rewrite ^/ui$ /ui/ redirect;
    chunked_transfer_encoding on;
    client_max_body_size 0;
    location / {
    proxy_read_timeout  2400s;
    proxy_pass_header   Server;
    proxy_cookie_path   ~*^/.* /;
    proxy_buffer_size 128k;
    proxy_buffers 40 128k;
    proxy_busy_buffers_size 128k;
    proxy_pass          http://192.168.31.100:8082;
    proxy_set_header    X-JFrog-Override-Base-Url $http_x_forwarded_proto://$host:$server_port;
    proxy_set_header    X-Forwarded-Port  $server_port;
    proxy_set_header    X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_set_header    Host              $http_host;
    proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
    add_header X-Content-Type-Options "nosniff" always;
 
        location ~ ^/artifactory/ {
            proxy_pass    http://192.168.31.100:8081;
        }
    }
}

## server configuration
server {
    listen 60080;
     
     
    server_name 192.168.31.100;
    if ($http_x_forwarded_proto = '') {
        set $http_x_forwarded_proto  $scheme;
    }
    ## Application specific logs
    ## access_log /var/log/nginx/192.168.31.100-access.log timing;
    ## error_log /var/log/nginx/192.168.31.100-error.log;
    rewrite ^/(v1|v2)/(.*) /artifactory/api/docker/group-images/$1/$2;
    chunked_transfer_encoding on;
    client_max_body_size 0;
    location / {
    proxy_read_timeout  2400s;
    proxy_pass_header   Server;
    proxy_cookie_path   ~*^/.* /;
    proxy_buffer_size 128k;
    proxy_buffers 40 128k;
    proxy_busy_buffers_size 128k;
    proxy_pass          http://192.168.31.100:8082;
    proxy_set_header    X-JFrog-Override-Base-Url $http_x_forwarded_proto://$host:$server_port;
    proxy_set_header    X-Forwarded-Port  $server_port;
    proxy_set_header    X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_set_header    Host              $http_host;
    proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
    add_header X-Content-Type-Options "nosniff" always;
 
        location ~ ^/artifactory/ {
            proxy_pass    http://192.168.31.100:8081;
        }
    }
}

```

启动一个 nginx 容器来代理

```bash
docker run -itd --name nginx-artifactory-proxy \
    -v /data/artifactory-data/nginx.conf:/etc/nginx/conf.d/nginx.conf \
    --network host \
    openresty/openresty:1.21.4.1-2-alpine
```

## 参考文档

- 安装 Artifactory：<https://www.jfrog.com/confluence/display/JFROG/Installing+Artifactory#1147598461cac81dc9df443cca4c115804d331211>
- Artifactory Docker Registry 的配置 <https://www.jfrog.com/confluence/display/JFROG/Docker+Registry>
